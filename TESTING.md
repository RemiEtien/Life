# –¢–µ—Å—Ç—ã Lifeline

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ **112 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤**, –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤

### Flutter Tests (83 —Ç–µ—Å—Ç–∞)
- **Encryption Service** (9 —Ç–µ—Å—Ç–æ–≤) - AES-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- **Memory Model** (48 —Ç–µ—Å—Ç–æ–≤) - –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
- **SyncState** (26 —Ç–µ—Å—Ç–æ–≤) - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### Cloud Functions Tests (29 —Ç–µ—Å—Ç–æ–≤)
- **Receipt Hash Generation** (5 —Ç–µ—Å—Ç–æ–≤) - SHA-256 —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤
- **Product ID Validation** (5 —Ç–µ—Å—Ç–æ–≤) - –≤–∞–ª–∏–¥–∞—Ü–∏—è ID –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- **Android Purchase Validation** (7 —Ç–µ—Å—Ç–æ–≤) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—É–ø–æ–∫ Google Play
- **iOS Purchase Validation** (7 —Ç–µ—Å—Ç–æ–≤) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—É–ø–æ–∫ App Store
- **Security & Edge Cases** (5 —Ç–µ—Å—Ç–æ–≤) - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –í—Å–µ Flutter —Ç–µ—Å—Ç—ã
```bash
flutter test
```

### –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã Flutter
```bash
# –¢–µ—Å—Ç—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
flutter test test/services/encryption_service_test.dart

# –¢–µ—Å—Ç—ã –º–æ–¥–µ–ª–∏ Memory
flutter test test/models/memory_test.dart

# –¢–µ—Å—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
flutter test test/services/sync_service_test.dart
```

### Cloud Functions —Ç–µ—Å—Ç—ã
```bash
cd functions
npm test
```

### –í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞–∑–æ–º
```bash
# Flutter —Ç–µ—Å—Ç—ã
flutter test

# Cloud Functions —Ç–µ—Å—Ç—ã (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
cd functions && npm test
```

## ‚úÖ –ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ —Ç–µ—Å—Ç–∞–º–∏

### 1. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (Encryption Service)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ AES-GCM
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
- ‚úÖ –†–∞–∑–Ω—ã–µ IV –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Ä–∞–∑–Ω—ã–µ —à–∏—Ñ—Ä—Ç–µ–∫—Å—Ç—ã
- ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –∏ Unicode —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ –§–æ—Ä–º–∞—Ç payload: `gcm_v1:IV:CIPHER`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

### 2. –ú–æ–¥–µ–ª—å Memory
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- ‚úÖ Getter/Setter –¥–ª—è —ç–º–æ—Ü–∏–π (emotionsData ‚Üî Map)
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ valence (—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏)
- ‚úÖ –ü–æ–¥—Å—á—ë—Ç insight score
- ‚úÖ Cover path helpers
- ‚úÖ copyWith() —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –ø–æ –∫–ª—é—á–∞–º
- ‚úÖ getFileKey() helper —Ñ—É–Ω–∫—Ü–∏—è

### 3. SyncState
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏/–∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- ‚úÖ copyWith() –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
- ‚úÖ Immutability
- ‚úÖ –¢–∏–ø–∏—á–Ω—ã–µ workflow —Å–æ—Å—Ç–æ—è–Ω–∏—è (idle, syncing, paused, complete, failed)
- ‚úÖ Progress –∑–Ω–∞—á–µ–Ω–∏—è (0.0, 0.1, 0.3, 0.6, 0.8, 0.9, 1.0)
- ‚úÖ Status —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Edge cases (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, progress > 1.0)

### 4. Purchase Verification (Cloud Functions)

#### Receipt Hash (SHA-256)
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–ª–ª–∏–∑–∏–π (vs —Å—Ç–∞—Ä–æ–≥–æ substring –ø–æ–¥—Ö–æ–¥–∞)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –∏ Unicode
- ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π hash –¥–ª—è –æ–¥–Ω–æ–≥–æ receipt)

#### Product ID Validation
- ‚úÖ –í–∞–ª–∏–¥–Ω—ã–µ ID: `lifeline_premium_monthly`, `lifeline_premium_yearly`
- ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö ID
- ‚úÖ Case-sensitive –ø—Ä–æ–≤–µ—Ä–∫–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL injection

#### Android Purchases (Google Play)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
- ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ purchaseState (0 = PURCHASED)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ acknowledgementState (1 = ACKNOWLEDGED)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
- ‚úÖ Edge case: –ø–æ–∫—É–ø–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —Ä–æ–≤–Ω–æ —Å–µ–π—á–∞—Å

#### iOS Purchases (App Store)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ bundle ID (`com.momentic.lifeline`)
- ‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ productId
- ‚úÖ –í—ã–±–æ—Ä —Å–∞–º–æ–π –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö receipt_info
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (expired + valid)

#### Security
- ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (100 –∏—Ç–µ—Ä–∞—Ü–∏–π)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö receipt —Å—Ç—Ä–æ–∫ (10000 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ Timestamp –≤–∞–ª–∏–¥–∞—Ü–∏—è (string –∏ number)

## üõ°Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –ø–æ–∫—Ä—ã—Ç—ã–µ —Ç–µ—Å—Ç–∞–º–∏

### 1. Receipt Replay Attack (CRITICAL - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω receipt –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
**–†–µ—à–µ–Ω–∏–µ:** SHA-256 —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + Firestore deduplication
**–¢–µ—Å—Ç—ã:**
- ‚úÖ –•–µ—à –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–¥–Ω–æ–≥–æ receipt
- ‚úÖ –•–µ—à —Ä–∞–∑–Ω—ã–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö receipt
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–ª–ª–∏–∑–∏–π

### 2. Product ID Injection (HIGH - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –±—ã–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ productId
**–†–µ—à–µ–Ω–∏–µ:** Whitelist –ø—Ä–æ–≤–µ—Ä–∫–∞
**–¢–µ—Å—Ç—ã:**
- ‚úÖ –¢–æ–ª—å–∫–æ 2 –≤–∞–ª–∏–¥–Ω—ã—Ö ID –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è
- ‚úÖ SQL injection –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è

### 3. Bundle ID Spoofing (HIGH - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è bundle_id –≤ iOS receipts
**–†–µ—à–µ–Ω–∏–µ:** –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `com.momentic.lifeline`
**–¢–µ—Å—Ç—ã:**
- ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π bundle ID –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è

### 4. Expired Purchase Acceptance (CRITICAL - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è expiry time
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ timestamp
**–¢–µ—Å—Ç—ã:**
- ‚úÖ Android: –∏—Å—Ç—ë–∫—à–∏–µ –ø–æ–∫—É–ø–∫–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- ‚úÖ iOS: –∏—Å—Ç—ë–∫—à–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- ‚úÖ Edge case: –ø–æ–∫—É–ø–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∞—è —Ä–æ–≤–Ω–æ —Å–µ–π—á–∞—Å

### 5. Wrong Product Purchase (MEDIUM - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å receipt –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
**–†–µ—à–µ–Ω–∏–µ:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ productId
**–¢–µ—Å—Ç—ã:**
- ‚úÖ iOS: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è latest_receipt_info –ø–æ productId
- ‚úÖ –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö

## üìù –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
flutter test test/models/memory_test.dart

# –° verbose –≤—ã–≤–æ–¥–æ–º
flutter test --verbose

# –° coverage
flutter test --coverage
```

### CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```yaml
# .github/workflows/tests.yml
name: Tests
on: [push, pull_request]
jobs:
  flutter-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test

  functions-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: cd functions && npm install && npm test
```

## üéØ –ß—Ç–æ –ù–ï –ø–æ–∫—Ä—ã—Ç–æ (–¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π)

- [ ] Widget tests –¥–ª—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] Integration tests —Å —Ä–µ–∞–ª—å–Ω—ã–º Firestore
- [ ] E2E —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ user flow
- [ ] Performance tests –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- [ ] Mock —Ç–µ—Å—Ç—ã –¥–ª—è SyncService (—Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö –º–æ–∫–æ–≤)
- [ ] Rate limiting —Ç–µ—Å—Ç—ã (—Ç—Ä–µ–±—É—é—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫)

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Flutter Tests:** `flutter_test` package
- **Cloud Functions Tests:** Jest 29.7.0
- **Assertions:** `expect()` API

### –°–æ–≥–ª–∞—à–µ–Ω–∏—è
- –ù–∞–∑–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –æ–ø–∏—Å—ã–≤–∞—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ (BDD style)
- Arrange-Act-Assert pattern
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (`group()` / `describe()`)
- Edge cases –≤—ã–¥–µ–ª–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
```bash
# Flutter coverage report
flutter test --coverage
genhtml coverage/lcov.info -o coverage/html

# Jest coverage
cd functions && npm test -- --coverage

# Watch mode –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
flutter test --watch  # (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –Ω—É–∂–µ–Ω –ø–ª–∞–≥–∏–Ω)
cd functions && npm test -- --watch
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-03
**–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 112 (83 Flutter + 29 Cloud Functions)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
